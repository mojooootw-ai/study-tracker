<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ğŸ“˜ å­¸ç¿’èª²ç¶±é€²åº¦è¿½è¹¤ v3.4 (Static)</title>
  <!-- Tailwind CSS via CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- React 18 + ReactDOM via CDN -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <!-- Babel (JSX è½‰è­¯æ–¼ç€è¦½å™¨) -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <!-- Chart.js for Monthly Stats -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    html, body { height: 100%; }
    /* ç°¡æ˜“å°è©±æ¡† & Snackbar */
    .modal-backdrop { background: rgba(0,0,0,0.25); }
  </style>
</head>
<body class="bg-gray-50 text-gray-900">
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useMemo, useRef } = React;

    // ------------------ æ—¥æœŸå°å·¥å…·ï¼ˆæœ¬åœ°æ™‚å€ï¼‰ ------------------
    const today = new Date();
    const fmtDate = (d) => {
      const y = d.getFullYear();
      const m = String(d.getMonth() + 1).padStart(2, "0");
      const dd = String(d.getDate()).padStart(2, "0");
      return `${y}-${m}-${dd}`;
    };
    const parseDate = (s) => { const [y, m, dd] = s.split("-").map(Number); return new Date(y, m-1, dd, 0,0,0,0); };
    const startOfISOWeek = (d) => { const day = d.getDay() || 7; const nd = new Date(d.getFullYear(), d.getMonth(), d.getDate()); nd.setDate(nd.getDate() - (day - 1)); nd.setHours(0,0,0,0); return nd; };
    const addDays = (d, n) => { const nd = new Date(d.getFullYear(), d.getMonth(), d.getDate()); nd.setDate(nd.getDate() + n); nd.setHours(0,0,0,0); return nd; };
    const yyyymm = (d) => `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;

    // ç‹€æ…‹ï¼š0=ç„¡/æœªå®Œæˆã€1=éƒ¨åˆ†ã€2=å…¨éƒ¨å®Œæˆ
    const mergeStatus = (a,b) => Math.max(a,b);

    function App(){
      const STORAGE_KEY = 'study-plan:v3.4';

      const [weeks, setWeeks] = useState(()=>{
        try { const raw = localStorage.getItem(STORAGE_KEY); return raw ? JSON.parse(raw) : []; } catch { return []; }
      });
      const [newWeekTitle, setNewWeekTitle] = useState('');
      const [newWeekStart, setNewWeekStart] = useState(fmtDate(today)); // é¡¯ç¤ºä»Šå¤©ï¼Œæ–°å¢æ™‚è‡ªå‹•å°é½Šé€±ä¸€
      const [activeTab, setActiveTab] = useState('week');
      const [month, setMonth] = useState(yyyymm(today));

      // åˆªé™¤å°è©±æ¡† & Undo
      const [deleteTarget, setDeleteTarget] = useState(null);
      const [lastDeleted, setLastDeleted] = useState(null); // { week, timer }

      const save = (list) => { setWeeks(list); try { localStorage.setItem(STORAGE_KEY, JSON.stringify(list)); } catch {} };

      // ä¸€æ¬¡æ€§é·ç§»ï¼šæŠŠèˆŠè³‡æ–™ startDate å°é½Šé€±ä¸€
      useEffect(()=>{
        if(!Array.isArray(weeks)) return;
        let changed = false;
        const fixed = weeks.map(w=>{
          if(!w.startDate) return w;
          const monday = startOfISOWeek(parseDate(w.startDate));
          const normalized = fmtDate(monday);
          if(normalized !== w.startDate){ changed = true; return { ...w, startDate: normalized }; }
          return w;
        });
        if(changed) save(fixed);
        // eslint-disable-next-line
      },[]);

      // é€±è¦–åœ–â€”æ–°å¢é€±
      const addWeek = () => {
        if(!newWeekTitle.trim() || !newWeekStart) return;
        const start = fmtDate(startOfISOWeek(parseDate(newWeekStart)));
        const week = {
          id: Date.now(),
          title: newWeekTitle.trim(),
          startDate: start,
          days: [
            { name: 'é€±ä¸€', tasks: [] },
            { name: 'é€±äºŒ', tasks: [] },
            { name: 'é€±ä¸‰', tasks: [] },
            { name: 'é€±å››', tasks: [] },
            { name: 'é€±äº”', tasks: [] },
            { name: 'é€±å…­', tasks: [] },
            { name: 'é€±æ—¥', tasks: [] },
          ],
        };
        save([...(weeks||[]), week]);
        setNewWeekTitle('');
      };

      // ä»»å‹™æ“ä½œ
      const addTask = (weekId, dayName, content) => {
        const list = (weeks||[]).map(w=>{
          if(w.id === weekId){
            const days = w.days.map(d=> d.name===dayName
              ? { ...d, tasks: [...d.tasks, { id: Date.now(), text: content, done: false }] }
              : d);
            return { ...w, days };
          }
          return w;
        });
        save(list);
      };
      const toggleTask = (weekId, dayName, taskId) => {
        const list = (weeks||[]).map(w=>{
          if(w.id === weekId){
            const days = w.days.map(d=> d.name===dayName
              ? { ...d, tasks: d.tasks.map(t=> t.id===taskId ? { ...t, done: !t.done } : t) }
              : d);
            return { ...w, days };
          }
          return w;
        });
        save(list);
      };
      const removeTask = (weekId, dayName, taskId) => {
        const list = (weeks||[]).map(w=>{
          if(w.id === weekId){
            const days = w.days.map(d=> d.name===dayName
              ? { ...d, tasks: d.tasks.filter(t=> t.id !== taskId) }
              : d);
            return { ...w, days };
          }
          return w;
        });
        save(list);
      };

      // æ•´é€±åˆªé™¤ + Undo
      const askRemoveWeek = (weekId) => { const t = (weeks||[]).find(w=>w.id===weekId) || null; setDeleteTarget(t); };
      const confirmRemoveWeek = () => {
        if(!deleteTarget) return;
        const removed = (weeks||[]).find(w=>w.id===deleteTarget.id) || null;
        const list = (weeks||[]).filter(w=> w.id !== deleteTarget.id);
        save(list);
        setDeleteTarget(null);
        const timer = setTimeout(()=> setLastDeleted(null), 5000);
        setLastDeleted({ week: removed, timer });
      };
      const cancelRemoveWeek = () => setDeleteTarget(null);
      const undoRemoveWeek = () => {
        if(!lastDeleted?.week) return;
        const restored = [...(weeks||[]), lastDeleted.week];
        restored.sort((a,b)=> (a.startDate||'').localeCompare(b.startDate||''));
        save(restored);
        if(lastDeleted.timer) clearTimeout(lastDeleted.timer);
        setLastDeleted(null);
      };

      // ç‹€æ…‹è¨ˆç®—èˆ‡æ¨£å¼
      const dayStatus = (day) => { if(!day.tasks || day.tasks.length===0) return 0; const done = day.tasks.filter(t=>t.done).length; if(done===0) return 0; if(done===day.tasks.length) return 2; return 1; };
      const dayBgClass = (s) => s===2? 'bg-green-50 border-green-200' : s===1? 'bg-amber-50 border-amber-200' : 'bg-gray-50 border-gray-200';
      const dayDot = (s) => s===2? 'bg-green-500' : s===1? 'bg-amber-500' : 'bg-gray-300';
      const weekProgress = (week) => { const doneDays = week.days.filter(d=> dayStatus(d)===2).length; return Math.round((doneDays/7)*100); };

      // æœˆæ›†çŸ©é™£
      const monthMatrix = useMemo(()=>{
        const [yy, mm] = month.split('-').map(Number);
        const first = new Date(yy, mm-1, 1);

        const statusByDate = new Map();
        const titlesByDate = new Map();

        for(const w of (weeks||[])){
          if(!w.startDate) continue;
          const base = parseDate(w.startDate);
          for(let i=0;i<7;i++){
            const d = addDays(base, i);
            const key = fmtDate(d);
            const y = parseInt(key.slice(0,4));
            const m = parseInt(key.slice(5,7));
            if(y!==yy || m!==mm) continue;
            const st = dayStatus(w.days[i]);
            const prev = statusByDate.get(key) ?? 0;
            statusByDate.set(key, mergeStatus(prev, st));
            const titles = titlesByDate.get(key) || [];
            if(!titles.includes(w.title)) titles.push(w.title);
            titlesByDate.set(key, titles);
          }
        }

        const start = startOfISOWeek(first);
        const rows = [];
        let cursor = start;
        for(let r=0;r<6;r++){
          const row = [];
          for(let i=0;i<7;i++){
            const key = fmtDate(cursor);
            const inMonth = cursor.getMonth() === (mm-1);
            const st = statusByDate.get(key) ?? 0;
            const titles = titlesByDate.get(key) || [];
            row.push({ date: new Date(cursor), key, inMonth, status: st, titles });
            cursor = addDays(cursor, 1);
          }
          rows.push(row);
        }
        return rows;
      }, [weeks, month]);

      // æœ¬æœˆé€±å®Œæˆç‡ï¼ˆChart.jsï¼‰
      const monthStats = useMemo(()=>{
        const [yy, mm] = month.split('-').map(Number);
        const inThisMonth = (dateStr) => { const y = parseInt(dateStr.slice(0,4)); const m = parseInt(dateStr.slice(5,7)); return y===yy && m===mm; };
        const list = [];
        for(const w of (weeks||[])){
          if(!w.startDate) continue;
          const base = parseDate(w.startDate);
          let overlaps = false;
          for(let i=0;i<7;i++){
            const key = fmtDate(addDays(base, i));
            if(inThisMonth(key)){ overlaps = true; break; }
          }
          if(overlaps) list.push({ label: w.startDate.slice(5), progress: weekProgress(w) });
        }
        list.sort((a,b)=> a.label.localeCompare(b.label));
        return list;
      }, [weeks, month]);

      // Chart.js ç¶å®š
      const chartRef = useRef(null);
      const chartInstance = useRef(null);
      useEffect(()=>{
        if(!chartRef.current) return;
        const labels = monthStats.map(x=>x.label);
        const data = monthStats.map(x=>x.progress);
        if(chartInstance.current){ chartInstance.current.destroy(); }
        chartInstance.current = new Chart(chartRef.current, {
          type: 'bar',
          data: { labels, datasets: [{ label: 'æœ¬æœˆé€±å®Œæˆç‡(%)', data, borderWidth: 1 }] },
          options: { scales: { y: { beginAtZero: true, max: 100 } } }
        });
      }, [monthStats]);

      return (
        <div className="p-6 max-w-6xl mx-auto">
          <h1 className="text-3xl font-bold mb-4">ğŸ“˜ å­¸ç¿’èª²ç¶±é€²åº¦è¿½è¹¤</h1>

          {/* Tabs */}
          <div className="inline-flex rounded-lg overflow-hidden border mb-4">
            <button className={`px-4 py-2 text-sm ${activeTab==='week'?'bg-white':'bg-gray-100'} hover:bg-white`} onClick={()=>setActiveTab('week')}>é€±è¦–åœ–</button>
            <button className={`px-4 py-2 text-sm ${activeTab==='calendar'?'bg-white':'bg-gray-100'} hover:bg-white`} onClick={()=>setActiveTab('calendar')}>æœˆæ›†æ¨¡å¼</button>
          </div>

          {activeTab==='week' && (
            <div>
              {/* æ–°å¢é€± */}
              <div className="flex flex-col gap-2 md:flex-row md:items-end md:gap-3 mb-4">
                <div className="flex-1 grid grid-cols-1 md:grid-cols-3 gap-2">
                  <div className="col-span-2 flex gap-2">
                    <input className="flex-1 border rounded px-3 py-2" placeholder="è¼¸å…¥æœ¬é€±ä¸»é¡Œï¼ˆä¾‹å¦‚ï¼šAI å·¥å…·ç ”ç©¶ã€è‹±èªå£èªªï¼‰" value={newWeekTitle} onChange={(e)=>setNewWeekTitle(e.target.value)} />
                    <button className="inline-flex items-center gap-1 px-3 py-2 bg-black text-white rounded" onClick={addWeek}>
                      <span className="text-lg leading-none">ï¼‹</span> æ–°å¢é€±
                    </button>
                  </div>
                  <div className="flex items-center gap-2">
                    <span className="text-gray-500">ğŸ“…</span>
                    <label className="text-sm text-gray-600">èµ·å§‹ï¼ˆæ˜ŸæœŸä¸€ï¼‰</label>
                    <input type="date" className="border rounded px-2 py-1" value={newWeekStart} onChange={(e)=>setNewWeekStart(e.target.value)} />
                  </div>
                </div>
              </div>

              {/* é€±å¡ç‰‡ */}
              {(weeks||[]).map((week)=>(
                <div key={week.id} className="mb-6 border shadow-sm rounded-lg bg-white">
                  <div className="p-4">
                    <div className="flex items-center justify-between mb-3">
                      <div>
                        <h2 className="text-xl font-semibold">{week.title}</h2>
                        <div className="text-xs text-gray-500">é€±ä¸€ï¼š{week.startDate || 'ï¼ˆå°šæœªè¨­å®šï¼‰'}</div>
                      </div>
                      <div className="flex items-center gap-3">
                        <div className="flex items-center gap-2">
                          {/* Progress */}
                          <div className="w-40 h-2 bg-gray-200 rounded overflow-hidden">
                            <div className="h-full bg-green-500" style={{ width: weekProgress(week)+'%' }}></div>
                          </div>
                          <span className="text-sm text-gray-600">{weekProgress(week)}%</span>
                        </div>
                        <button title="åˆªé™¤é€™æ•´é€±" className="p-2 rounded hover:bg-red-50" onClick={()=>askRemoveWeek(week.id)}>
                          <span className="text-red-500">ğŸ—‘ï¸</span>
                        </button>
                      </div>
                    </div>

                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                      {week.days.map((day, idx)=>{
                        const st = dayStatus(day);
                        const bg = dayBgClass(st);
                        return (
                          <div key={day.name} className={`border rounded-lg p-3 ${bg}`}>
                            <div className="flex items-center justify-between mb-2">
                              <div className="flex items-center gap-2">
                                <span className={`inline-block h-2.5 w-2.5 rounded-full ${dayDot(st)}`}></span>
                                <h3 className="font-medium">{day.name}</h3>
                              </div>
                              <div className="text-xs text-gray-500">{week.startDate ? fmtDate(addDays(parseDate(week.startDate), idx)) : ''}</div>
                            </div>

                            {(day.tasks||[]).map(task=> (
                              <div key={task.id} className="flex items-center justify-between mb-1">
                                <label className="flex items-center gap-2">
                                  <input type="checkbox" checked={task.done} onChange={()=>toggleTask(week.id, day.name, task.id)} />
                                  <span className={task.done? 'line-through text-gray-500' : ''}>{task.text}</span>
                                </label>
                                <button className="p-1 hover:bg-gray-100 rounded" onClick={()=>removeTask(week.id, day.name, task.id)}>ğŸ—‘ï¸</button>
                              </div>
                            ))}

                            <AddTaskForm onAdd={(text)=>addTask(week.id, day.name, text)} />
                          </div>
                        );
                      })}
                    </div>
                  </div>
                </div>
              ))}
            </div>
          )}

          {activeTab==='calendar' && (
            <div className="border rounded-lg bg-white">
              <div className="p-4">
                <div className="flex items-center gap-2 mb-3">
                  <span className="text-gray-500">ğŸ“…</span>
                  <label className="text-sm text-gray-600">é¸æ“‡æœˆä»½</label>
                  <input type="month" className="border rounded px-2 py-1 w-40" value={month} onChange={(e)=>setMonth(e.target.value)} />
                  <div className="ml-auto text-xs text-gray-500 flex items-center gap-3">
                    <span className="inline-flex items-center gap-1"><span className="h-2.5 w-2.5 rounded-full bg-green-500 inline-block"></span>å®Œæˆ</span>
                    <span className="inline-flex items-center gap-1"><span className="h-2.5 w-2.5 rounded-full bg-amber-500 inline-block"></span>éƒ¨åˆ†</span>
                    <span className="inline-flex items-center gap-1"><span className="h-2.5 w-2.5 rounded-full bg-gray-300 inline-block"></span>ç„¡/æœªå®Œæˆ</span>
                  </div>
                </div>

                <div className="grid grid-cols-7 text-center text-xs text-gray-600 mb-2">
                  {['ä¸€','äºŒ','ä¸‰','å››','äº”','å…­','æ—¥'].map(d=> <div key={d} className="py-1">é€±{d}</div>)}
                </div>

                <div className="grid grid-cols-7 gap-1">
                  {monthMatrix.map((row, i)=> (
                    <React.Fragment key={i}>
                      {row.map(cell => (
                        <div key={cell.key} className={`h-24 border rounded-md p-1 ${cell.inMonth? 'bg-white' : 'bg-gray-50'}`}>
                          <div className="flex items-center justify-between text-xs">
                            <span className="text-gray-700">{cell.date.getDate()}</span>
                            <span className={`h-2.5 w-2.5 rounded-full ${cell.status===2?'bg-green-500':cell.status===1?'bg-amber-500':'bg-gray-300'}`}></span>
                          </div>
                          <div className="mt-1 space-y-1">
                            {cell.titles.slice(0,2).map((t, i)=> (
                              <div key={i} className="text-[10px] truncate px-1 py-0.5 rounded bg-gray-100 text-gray-700 border">{t}</div>
                            ))}
                            {cell.titles.length>2 && <div className="text-[10px] text-gray-500">â€¦ å¦æœ‰ {cell.titles.length-2} é€±</div>}
                          </div>
                        </div>
                      ))}
                    </React.Fragment>
                  ))}
                </div>

                {/* æœ¬æœˆé€±å®Œæˆç‡ */}
                <div className="mt-6">
                  <div className="text-sm font-medium mb-2">æœ¬æœˆé€±å®Œæˆç‡</div>
                  <div className="h-56 w-full">
                    <canvas ref={chartRef}></canvas>
                  </div>
                </div>

                {(weeks||[]).length===0 && (
                  <div className="text-sm text-gray-500 mt-3">æç¤ºï¼šå…ˆåˆ°ã€Œé€±è¦–åœ–ã€æ–°å¢ä¸€å€‹é€±ä¸»é¡Œä¸¦è¨­å®šã€Œèµ·å§‹ï¼ˆæ˜ŸæœŸä¸€ï¼‰ã€ä»¥åœ¨æœˆæ›†ä¸­é¡¯ç¤ºã€‚</div>
                )}
              </div>
            </div>
          )}

          {/* åˆªé™¤æ•´é€±ç¢ºèªå°è©±æ¡† */}
          {deleteTarget && (
            <div className="fixed inset-0 flex items-center justify-center modal-backdrop">
              <div className="bg-white rounded-xl shadow-xl p-5 w-[90%] max-w-md">
                <div className="text-lg font-semibold mb-2">åˆªé™¤æ•´é€±</div>
                <div className="text-sm text-gray-700 mb-4">ç¢ºå®šè¦åˆªé™¤ã€Œ{deleteTarget?.title || 'é€™ä¸€é€±'}ã€å—ï¼Ÿæ­¤å‹•ä½œç„¡æ³•å¾©åŸã€‚</div>
                <div className="flex justify-end gap-2">
                  <button className="px-3 py-2 rounded border" onClick={cancelRemoveWeek}>å–æ¶ˆ</button>
                  <button className="px-3 py-2 rounded bg-red-600 text-white" onClick={confirmRemoveWeek}>åˆªé™¤</button>
                </div>
              </div>
            </div>
          )}

          {/* Undo æ’¤éŠ·åˆªé™¤ Snackbar */}
          {lastDeleted?.week && (
            <div className="fixed bottom-4 right-4 bg-gray-900 text-white rounded-xl shadow-lg px-4 py-3 flex items-center gap-3 z-50">
              <span className="text-sm">å·²åˆªé™¤ã€Œ{lastDeleted.week.title}ã€</span>
              <button className="px-3 py-1.5 rounded bg-white text-gray-900" onClick={undoRemoveWeek}>é‚„åŸ</button>
              <button className="px-2 py-1.5 rounded hover:bg-white/10" onClick={()=>{ if(lastDeleted.timer) clearTimeout(lastDeleted.timer); setLastDeleted(null); }}>é—œé–‰</button>
            </div>
          )}
        </div>
      );
    }

    function AddTaskForm({ onAdd }){
      const [text, setText] = useState('');
      const handleAdd = () => { if(!text.trim()) return; onAdd(text.trim()); setText(''); };
      return (
        <div className="flex gap-2 mt-2">
          <input className="flex-1 border rounded px-3 py-2" placeholder="è¼¸å…¥ä»Šæ—¥å­¸ç¿’å…§å®¹" value={text} onChange={(e)=>setText(e.target.value)} />
          <button className="px-3 py-2 bg-gray-900 text-white rounded" onClick={handleAdd}>ï¼‹</button>
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
